<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Gestão | Tema Escuro</title>
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome para Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
    </style>
</head>
<body>

    <div class="container-principal">
        <!-- Sidebar para Cadastro -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <h2>GestãoPro</h2>
            </header>
            
            <form id="form-cadastro">
                <h3>Novo Colaborador</h3>
                <div class="form-group">
                    <label for="nome">Nome Completo</label>
                    <input type="text" id="nome" required placeholder="Ex: Carlos Andrade">
                </div>
                <div class="form-group">
                    <label for="funcao">Função (Cargo)</label>
                    <input type="text" id="funcao" required placeholder="Ex: Engenheiro de Produção">
                </div>
                <div class="form-group">
                    <label for="setor">Setor</label>
                    <select id="setor" required>
                        <option value="" disabled selected>Selecione um setor</option>
                        <option value="Administrativo">Administrativo</option>
                        <option value="Comercial">Comercial</option>
                        <option value="Produção">Produção</option>
                        <option value="Quebragem">Quebragem</option>
                        <option value="Qualidade">Qualidade</option>
                        <option value="Manutenção">Manutenção</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-cadastrar">
                    <i class="fas fa-plus-circle"></i> Adicionar
                </button>
            </form>

            <div class="admin-actions">
                <button id="btn-limpar-tudo" class="btn btn-perigo">
                    <i class="fas fa-exclamation-triangle"></i> Limpar Tudo
                </button>
            </div>
        </aside>

        <!-- Conteúdo Principal do Dashboard -->
        <main class="main-content">
            <header class="main-header">
                <h1>Visão Geral</h1>
                <p>Acompanhe os indicadores e a equipe em tempo real.</p>
            </header>

            <!-- Cards de Resumo -->
            <section class="dashboard-cards">
                <div class="card total">
                    <div class="card-icon"><i class="fas fa-users"></i></div>
                    <div class="card-info">
                        <p>Total de Colaboradores</p>
                        <h3 id="total-funcionarios">0</h3>
                    </div>
                </div>
                <div class="card administrativo">
                    <div class="card-icon"><i class="fas fa-briefcase"></i></div>
                    <div class="card-info">
                        <p>Administrativo</p>
                        <h3 id="total-administrativo">0</h3>
                    </div>
                </div>
                <div class="card comercial">
                     <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="card-info">
                        <p>Comercial</p>
                        <h3 id="total-comercial">0</h3>
                    </div>
                </div>
                 <div class="card producao">
                     <div class="card-icon"><i class="fas fa-cogs"></i></div>
                    <div class="card-info">
                        <p>Produção</p>
                        <h3 id="total-producao">0</h3>
                    </div>
                </div>
                <div class="card quebragem">
                     <div class="card-icon"><i class="fas fa-hammer"></i></div>
                    <div class="card-info">
                        <p>Quebragem</p>
                        <h3 id="total-quebragem">0</h3>
                    </div>
                </div>
                <div class="card qualidade">
                     <div class="card-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="card-info">
                        <p>Qualidade</p>
                        <h3 id="total-qualidade">0</h3>
                    </div>
                </div>
                <div class="card manutencao">
                     <div class="card-icon"><i class="fas fa-tools"></i></div>
                    <div class="card-info">
                        <p>Manutenção</p>
                        <h3 id="total-manutencao">0</h3>
                    </div>
                </div>
            </section>

            <!-- Lista de Funcionários -->
            <section class="employee-list">
                <div class="employee-list-header">
                    <h2>Equipe</h2>
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="busca" placeholder="Buscar por nome, função ou setor...">
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome Completo</th>
                                <th>Função</th>
                                <th>Setor</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-funcionarios">
                            <!-- Linhas serão inseridas dinamicamente pelo JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Modal de Confirmação -->
    <div class="modal-overlay" id="confirmation-modal">
        <div class="modal-content">
            <h3 id="modal-title">Confirmar Ação</h3>
            <p id="modal-message">Você tem certeza?</p>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="modal-btn">Cancelar</button>
                <button id="modal-confirm-btn" class="modal-btn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- SDKs do Firebase (versão modular) -->
    <script type="module">
        // Importe as funções que você precisa dos SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // =================================================================================
        // ATENÇÃO: Substitua o objeto abaixo pela configuração do seu projeto Firebase
        // =================================================================================
        const firebaseConfig = {
            apiKey: "COLE_SUA_API_KEY_AQUI",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // --- INICIALIZAÇÃO DO FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const funcionariosCollection = collection(db, 'funcionarios');

        // --- SELETORES DO DOM ---
        const formCadastro = document.getElementById('form-cadastro');
        const listaFuncionariosTbody = document.getElementById('lista-funcionarios');
        const buscaInput = document.getElementById('busca');
        const btnLimparTudo = document.getElementById('btn-limpar-tudo');
        
        const contadoresEl = {
            total: document.getElementById('total-funcionarios'),
            administrativo: document.getElementById('total-administrativo'),
            comercial: document.getElementById('total-comercial'),
            producao: document.getElementById('total-producao'),
            quebragem: document.getElementById('total-quebragem'),
            qualidade: document.getElementById('total-qualidade'),
            manutencao: document.getElementById('total-manutencao')
        };
        
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');


        let funcionariosCache = []; 
        let resolvePromise = null;

        // --- FUNÇÕES DO MODAL ---
        function showConfirmationModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.add('visible');
            
            return new Promise((resolve) => {
                resolvePromise = resolve;
            });
        }

        function closeModal(resolution) {
            if (resolvePromise) resolvePromise(resolution);
            modal.classList.remove('visible');
        }

        modalConfirmBtn.addEventListener('click', () => closeModal(true));
        modalCancelBtn.addEventListener('click', () => closeModal(false));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal(false);
        });

        // --- FUNÇÕES PRINCIPAIS ---
        function animateCount(el, endValue) {
            const startValue = parseInt(el.textContent, 10) || 0;
            if (startValue === endValue) return;
            
            const duration = 1000;
            let startTime = null;

            function animation(currentTime) {
                if (!startTime) startTime = currentTime;
                const progress = Math.min((currentTime - startTime) / duration, 1);
                const currentValue = Math.floor(progress * (endValue - startValue) + startValue);
                el.textContent = currentValue;
                if (progress < 1) {
                    requestAnimationFrame(animation);
                }
            }
            requestAnimationFrame(animation);
        }

        const renderizarDashboard = (funcionarios) => {
            listaFuncionariosTbody.innerHTML = '';
            const contadoresSetor = {
                Administrativo: 0, Comercial: 0, Produção: 0, 
                Quebragem: 0, Qualidade: 0, Manutenção: 0
            };

            if (funcionarios.length === 0) {
                listaFuncionariosTbody.innerHTML = '<tr class="empty-row"><td colspan="4">Nenhum colaborador cadastrado.</td></tr>';
            } else {
                funcionarios.forEach(func => {
                    const setorClass = func.setor.toLowerCase().replace('ç', 'c').replace('ã', 'a');
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${func.nome}</td>
                        <td>${func.funcao}</td>
                        <td><span class="setor-badge setor-${setorClass}">${func.setor}</span></td>
                        <td>
                            <button class="btn-excluir" data-id="${func.id}" title="Excluir colaborador">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    listaFuncionariosTbody.appendChild(tr);

                    if (contadoresSetor.hasOwnProperty(func.setor)) {
                        contadoresSetor[func.setor]++;
                    }
                });
            }

            animateCount(contadoresEl.total, funcionarios.length);
            animateCount(contadoresEl.administrativo, contadoresSetor.Administrativo);
            animateCount(contadoresEl.comercial, contadoresSetor.Comercial);
            animateCount(contadoresEl.producao, contadoresSetor.Produção);
            animateCount(contadoresEl.quebragem, contadoresSetor.Quebragem);
            animateCount(contadoresEl.qualidade, contadoresSetor.Qualidade);
            animateCount(contadoresEl.manutencao, contadoresSetor.Manutenção);
        };

        const filtrarErenderizar = () => {
            const termoBusca = buscaInput.value.toLowerCase().trim();
            
            if (!termoBusca) {
                renderizarDashboard(funcionariosCache);
                return;
            }

            const funcionariosFiltrados = funcionariosCache.filter(func => 
                func.nome.toLowerCase().includes(termoBusca) || 
                func.funcao.toLowerCase().includes(termoBusca) ||
                func.setor.toLowerCase().includes(termoBusca)
            );
            renderizarDashboard(funcionariosFiltrados);
        };

        // --- EVENT LISTENERS ---
        formCadastro.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { nome, funcao, setor } = formCadastro.elements;

            if (!nome.value || !funcao.value || !setor.value) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            try {
                await addDoc(funcionariosCollection, {
                    nome: nome.value.trim(),
                    funcao: funcao.value.trim(),
                    setor: setor.value,
                    dataCadastro: new Date().toISOString()
                });
                formCadastro.reset();
                nome.focus();
            } catch (error) {
                console.error("Erro ao cadastrar funcionário: ", error);
                alert("Ocorreu um erro ao cadastrar. Tente novamente.");
            }
        });

        listaFuncionariosTbody.addEventListener('click', async (e) => {
            const button = e.target.closest('.btn-excluir');
            if (button) {
                const id = button.dataset.id;
                const nomeFuncionario = button.closest('tr').cells[0].textContent;
                
                const confirmado = await showConfirmationModal(
                    'Excluir Colaborador', 
                    `Tem certeza que deseja remover "${nomeFuncionario}" da equipe?`
                );

                if (confirmado) {
                    try {
                        await deleteDoc(doc(db, 'funcionarios', id));
                    } catch (error) {
                        console.error("Erro ao excluir funcionário: ", error);
                        alert("Ocorreu um erro ao excluir. Tente novamente.");
                    }
                }
            }
        });

        buscaInput.addEventListener('input', filtrarErenderizar);

        btnLimparTudo.addEventListener('click', async () => {
            const confirmado = await showConfirmationModal(
                'Limpar Todos os Dados', 
                'ATENÇÃO! Esta ação é irreversível e excluirá TODOS os registros de colaboradores. Deseja continuar?'
            );

            if (confirmado) {
                try {
                    const querySnapshot = await getDocs(funcionariosCollection);
                    if (querySnapshot.empty) return;
                    
                    const batch = writeBatch(db);
                    querySnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();

                } catch (error) {
                     console.error("Erro ao limpar a coleção: ", error);
                     alert("Ocorreu um erro ao limpar os dados.");
                }
            }
        });

        // --- LISTENER EM TEMPO REAL DO FIRESTORE ---
        onSnapshot(funcionariosCollection, (snapshot) => {
            funcionariosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            funcionariosCache.sort((a, b) => a.nome.localeCompare(b.nome)); 
            filtrarErenderizar();
        });

    </script>
</body>
</html>

